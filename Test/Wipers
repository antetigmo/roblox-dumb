using System;
using System.Collections;
using HutongGames.PlayMaker;
using MSCLoader;
using UnityEngine;

namespace Panier250
{
	// Token: 0x0200007E RID: 126
	public class Wipers : MonoBehaviour
	{
		// Token: 0x060001F0 RID: 496 RVA: 0x00014188 File Offset: 0x00012388
		private void Start()
		{
			this.interactIcon = FsmVariables.GlobalVariables.FindFsmBool("GUIuse");
			this.interactText = FsmVariables.GlobalVariables.FindFsmString("GUIinteraction");
			this.sfx.clip = GameObject.Find("MasterAudio/CarFoley/wiper_loop").GetComponent<AudioSource>().clip;
			this.sfx.volume = 1f;
			this.sfx.pitch = 2.2f;
			base.StartCoroutine(this.SetupScr());
		}

		// Token: 0x060001F1 RID: 497 RVA: 0x0001420C File Offset: 0x0001240C
		private void Update()
		{
			this.delay -= Time.deltaTime;
			this.delay = Mathf.Clamp(this.delay, 0f, 1f);
			if (this.raycast.GetHit(this.trig))
			{
				this.interactIcon.Value = true;
				this.interactText.Value = "WIPERS";
				this.mouseover = true;
				if (Input.GetMouseButtonDown(0) && this.delay <= 0f)
				{
					this.WiperState++;
					if (this.WiperState > 3)
					{
						this.WiperState = 0;
					}
					this.S_ON.Play();
					this.delay = 0.05f;
				}
				if (Input.GetMouseButtonDown(1))
				{
					this.RotY = 11f;
					this.wash = true;
					if (this.sys.ignition.KeyInIgnition && !this.sys.water.inWater)
					{
						this.wash1.Play();
					}
					this.washc = base.StartCoroutine(this.Spray());
				}
			}
			else if (this.mouseover)
			{
				this.interactIcon.Value = false;
				this.interactText.Value = "";
				this.mouseover = false;
			}
			if (this.drivetrigger.PlayerInDrivingmode && cInput.GetButtonDown("Wipers") && this.delay <= 0f)
			{
				this.WiperState++;
				if (this.WiperState > 3)
				{
					this.WiperState = 0;
				}
				this.S_ON.Play();
				this.delay = 0.05f;
			}
			if (this.wash && Input.GetMouseButtonUp(1))
			{
				this.wash = false;
				this.RotY = 0f;
				this.wash1.Stop();
				if (this.washc != null)
				{
					base.StopCoroutine(this.washc);
				}
				if (this.c2 == null)
				{
					this.c2 = base.StartCoroutine(this.again());
				}
			}
			if (this.wash && this.WiperState == 0 && this.sys.ignition.KeyInIgnition && !this.sys.water.inWater)
			{
				if (!this.wash1.isPlaying)
				{
					this.wash1.Play();
				}
				if (!this.anim.isPlaying)
				{
					this.anim.Play();
					if (this.anim["wiper"].speed != 1f)
					{
						this.anim["wiper"].speed = 1f;
						this.sfx.pitch = 2.2f;
					}
					this.wiperdelay = 0f;
				}
			}
			this.stalk.localEulerAngles = new Vector3(this.WiperStalkRot[this.WiperState], this.RotY, 0f);
			if (this.raincrap.ws != null && this.sys.ignition.KeyInIgnition && !this.sys.water.inWater)
			{
				switch (this.WiperState)
				{
				case 0:
					if (this.anim["wiper"].time == 0f && this.anim.isPlaying && !this.wash && !this.stop1)
					{
						this.anim.Stop();
					}
					break;
				case 1:
					if (!this.anim.isPlaying && this.wiperdelay >= 2.5f)
					{
						this.anim.Play();
						if (this.anim["wiper"].speed != 1f)
						{
							this.anim["wiper"].speed = 1f;
							this.sfx.pitch = 2.2f;
						}
						this.wiperdelay = 0f;
					}
					break;
				case 2:
					if (!this.anim.isPlaying)
					{
						this.anim.Play();
						if (this.anim["wiper"].speed != 1f)
						{
							this.anim["wiper"].speed = 1f;
							this.sfx.pitch = 2.2f;
						}
						this.wiperdelay = 0f;
					}
					break;
				case 3:
					if (!this.anim.isPlaying)
					{
						this.anim.Play();
						if (this.anim["wiper"].speed != 1.33f)
						{
							this.anim["wiper"].speed = 1.33f;
							this.sfx.pitch = 2.4f;
						}
						this.wiperdelay = 0f;
					}
					break;
				}
			}
			else if (this.anim["wiper"].time == 0f && this.anim.isPlaying)
			{
				this.anim.Stop();
			}
			if (this.wiperdelay < 3f)
			{
				this.wiperdelay += Time.deltaTime;
			}
		}

		// Token: 0x060001F2 RID: 498 RVA: 0x0001475F File Offset: 0x0001295F
		private IEnumerator SetupScr()
		{
			yield return new WaitForSeconds(5f);
			if (this.raincrap.ws != null)
			{
				this.script = PlayMakerExtensions.GetPlayMaker(this.raincrap.ws.gameObject, "Speed");
			}
			yield break;
		}

		// Token: 0x060001F3 RID: 499 RVA: 0x0001476E File Offset: 0x0001296E
		private IEnumerator Spray()
		{
			for (;;)
			{
				yield return new WaitForSeconds(this.waits);
				if (this.script != null && this.wash1.isPlaying)
				{
					this.script.SendEvent("RADIATOR");
				}
			}
			yield break;
		}

		// Token: 0x060001F4 RID: 500 RVA: 0x0001477D File Offset: 0x0001297D
		private IEnumerator again()
		{
			while (this.anim.isPlaying || this.WiperState != 0 || this.stop1)
			{
				yield return null;
			}
			this.stop1 = true;
			this.anim.Play("wiper");
			if (this.anim["wiper"].speed != 1f)
			{
				this.anim["wiper"].speed = 1f;
				this.sfx.pitch = 2.2f;
			}
			yield return new WaitForSeconds(0.1f);
			this.stop1 = false;
			this.c2 = null;
			yield break;
		}

		// Token: 0x040004FA RID: 1274
		public InteractionRaycast raycast;

		// Token: 0x040004FB RID: 1275
		public DriveTrigger drivetrigger;

		// Token: 0x040004FC RID: 1276
		public Collider trig;

		// Token: 0x040004FD RID: 1277
		public AudioSource S_ON;

		// Token: 0x040004FE RID: 1278
		public Transform stalk;

		// Token: 0x040004FF RID: 1279
		private FsmBool interactIcon;

		// Token: 0x04000500 RID: 1280
		private FsmString interactText;

		// Token: 0x04000501 RID: 1281
		private bool mouseover;

		// Token: 0x04000502 RID: 1282
		private float delay;

		// Token: 0x04000503 RID: 1283
		public int WiperState;

		// Token: 0x04000504 RID: 1284
		public RainCrap raincrap;

		// Token: 0x04000505 RID: 1285
		public StarterSystem sys;

		// Token: 0x04000506 RID: 1286
		public Animation anim;

		// Token: 0x04000507 RID: 1287
		private float wiperdelay;

		// Token: 0x04000508 RID: 1288
		public AudioSource sfx;

		// Token: 0x04000509 RID: 1289
		private float[] WiperStalkRot = new float[]
		{
			0f,
			10f,
			17.5f,
			24f
		};

		// Token: 0x0400050A RID: 1290
		private float RotY;

		// Token: 0x0400050B RID: 1291
		private bool wash;

		// Token: 0x0400050C RID: 1292
		public AudioSource wash1;

		// Token: 0x0400050D RID: 1293
		private PlayMakerFSM script;

		// Token: 0x0400050E RID: 1294
		private float waits = 0.1f;

		// Token: 0x0400050F RID: 1295
		private Coroutine washc;

		// Token: 0x04000510 RID: 1296
		private Coroutine c2;

		// Token: 0x04000511 RID: 1297
		private bool stop1;
	}
}
