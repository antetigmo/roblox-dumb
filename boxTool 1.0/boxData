local boxData = {}
boxData.__index = boxData

local ReplicatedStorage = game:GetService("ReplicatedStorage")
local ServerStorage= game:GetService("ServerStorage")
local PlayersService = game:GetService("Players")
local CollectionService = game:GetService("CollectionService")

local ServerToClient = ReplicatedStorage.ServerToClient
local ServerToServer = ReplicatedStorage.ServerToServer

local boxFolder = game.Workspace.Boxes.Tools:GetChildren()
boxData.boxesUsed = {}
local toolsFolder = {}

function boxData.new(object, player)
	local self = setmetatable({}, boxData)
	self.Object = object
	self.player = player
	self._topicEvent = ReplicatedStorage.TopicEvent
	
	self.Debounce = false
	print("boxData created.")
	
	return self
end

function boxData:Init()
	self:CreatePrompt()

	self.Connection = self:SubscribeTopic("BoxAssignedTo", function(player, ...)
		self:OnBoxAssignedTo(player, ...)
	end)
	
	self.BoxDroppedEvent = self.Object:SubscribeTopic("BoxDropped", function(player, Box)
		self:OnBoxDropped(player, Box)
	end) 
end

function boxData:OnBoxDropped(player, Box)
	local Prompt = Box.Base.Attachment:FindFirstChild("ProximityPrompt") or self:CreatePrompt(Box, player) 
	ServerToServer:Fire(player, Box)
end

function boxData:OnBoxAssignedTo(player, box)
	boxData.boxesUsed[player.Name] = {player, box}
	print(boxData.boxesUsed)
end

function boxData:CreatePrompt(box, player)
	local Box = box
	if self.Debounce == false then
		self.Debounce = true
		for i, boxes in ipairs(boxFolder) do
			toolsFolder[i] = boxes

			Box = boxes
			local Prompt = Box.Base.Attachment:FindFirstChild("ProximityPrompt") or Instance.new("ProximityPrompt")
			Prompt.HoldDuration = 0.5
			Prompt.Parent =  toolsFolder[i].Base.Attachment
		end
	else
		local Prompt = Box.Base.Attachment:FindFirstChild("ProximityPrompt") or Instance.new("ProximityPrompt")
		Prompt.HoldDuration = 0.5
		Prompt.Parent = Box.Base.Attachment
		
		local boxInfo = self.Object:GetBox(Box)

		table.remove(boxData.boxesUsed[player.Name], 2)
		print("Removed box:", Box,"from player:", player, boxData.boxesUsed[player.Name], "array.")
		warn(boxData.boxesUsed)
	
		return Prompt
	end
end

function boxData:PublishTopic(topicName, player, ...)
	self._topicEvent:Fire(topicName, self.player, ...)	
	--print("Published topic: " .. topicName)
end

function boxData:SubscribeTopic(topicName, callBack)
	local connection = self._topicEvent.Event:Connect(function(name, player, ...)
		if name == topicName then
			callBack(player, ...)
		end
	end)
	return connection
end

return boxData
