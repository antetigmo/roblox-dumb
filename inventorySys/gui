local ReplicatedStorage = game:GetService("ReplicatedStorage")
local ClientToServer = ReplicatedStorage.ClickInventory

local guiHandler = {}
guiHandler.__index = guiHandler
guiHandler.instanceNumber = 0

local versionN = "1.0.0"

function guiHandler.new(object, player)
	guiHandler.instanceNumber += 1
	local self = setmetatable({}, guiHandler)

	self.object = object
	self.player = player
	self.name = "guiHandler"
	self.instanceID = guiHandler.instanceNumber

	self.inventoryUi = player.PlayerGui.inventoryUi
	self.slotsUsed = {}

	return self
end

function guiHandler:Init()
	self:ConnectAll()
	self.slots = self:AddressSlots()
end

function guiHandler:ConnectAll()
	self.PromptPressedConnection = self.object:m_SubscribeTopic("Pressed", function(player, item, instanceID)
		if player == self.player then
			self.actualItemInstanceID = instanceID
			self:SetIcon(item)
		end
	end)

	self.MouseClickedConnection = ClientToServer.OnServerEvent:Connect(function(player, slot)
		if player == self.player then
			self:OnMouseClicked(player, slot)
			--self.object.slots = amountOfSlots
		end
	end)
end

function guiHandler:DisconnectAll()
	self.MouseClickedConnection:Disconnect()
end

function guiHandler:AddressSlots() -- temporary function, need to re-do,
	local slotsChildren = self.inventoryUi.Main.ScrollingFrame:GetChildren()
	local amountOfSlots = {}
	local index = 0

	for _, slot in pairs(slotsChildren) do
		if slot:IsA("Frame") then
			index +=1
			amountOfSlots[index] = {slot}
			-- CADA SLOT QUANDO PREENCHIDO VAI TER O INSTANCEID QUE É O COMPONENTE ITEM, E O NOME DO ITEM QUE ESTÁ LA
			-- ASSIM A FUNÇÃO ONMOUSECLICKED VAI USAR O INSTANCEID DO ITEM PRA PROCURAR O COMPONENTE E USAR A FUNÇÃO CREATEHANDLE DO COMPONENTE CERTO.
			-- OU SEJA, PROCURAR O ITEM NO SLOT E DEPOIS USAR A FUNÇÃO DO COMPONENTE COM INSTANCEID DELE.
		end
	end

	return amountOfSlots
end

function guiHandler:CheckAvailableFrame()
	for i, availableSlot in ipairs(self.slots) do
		if not availableSlot[1]:FindFirstChildWhichIsA("ImageLabel") then
			local data = {availableSlot[i], i}
			return data
		end
	end
end

function guiHandler:SetIcon(item)
	local slotData = self:CheckAvailableFrame()
	local icon = item.Icon
	slotData.instanceID = self.actualItemInstanceID
	icon.Parent = slotData[1]
end

function guiHandler:OnMouseClicked(player, slot)
	--print(self.actualItemInstanceID)
	--self.object.Components.item[instanceID]:CreateHandle(item)
end

warn("InventoryUi version:", versionN)

return guiHandler
