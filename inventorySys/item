local ReplicatedStorage = game:GetService("ReplicatedStorage")
local ServerStorage= game:GetService("ServerStorage")
local PlayersService = game:GetService("Players")
local CollectionService = game:GetService("CollectionService")

local ClientToServer = ReplicatedStorage.ClientToServer
local ServerToClient = ReplicatedStorage.ServerToClient
local ServerToServer = ReplicatedStorage.ServerToServer

local item = {}
item.__index = item
item.instanceNumber = 0

item.itemsActive = {}

MAX_OF_ITEMS = 5

function item.new(object, itemObject)
	item.instanceNumber += 1
	
	local self = setmetatable({}, item)
	self.object = object
	self.itemObject = itemObject
	self.name = "item"
	self.instanceID = item.instanceNumber
	
	return self
end

function item:Init()
	self:CreatePrompt(self.itemObject)
	self:Connect()
end

function item:Connect()
	self.Triggered = self.Prompt.Triggered:Connect(function(player)
		self:Press(player, self.itemObject)
	end)	
	warn("Item prompt trigger connection.")
	
	self.Equipped = self.itemObject.Equipped:Connect(function()
		local player = PlayersService:GetPlayerFromCharacter(self.itemObject.Parent) or nil
		if player == self.object.player then
			self.object.currentItemEquipped = self.itemObject
		end
	end)
	
	self.Unequipped = self.itemObject.Unequipped:Connect(function()
		local player = PlayersService:GetPlayerFromCharacter(self.itemObject.Parent.Parent) or nil
		if player == self.object.player then
			self.object.currentItemEquipped = nil
		end
	end)
	
	self.object:m_SubscribeTopic("itemDropped", function(player, item)
		print("Player:", player, "dropped:", item)
		if self.itemsActive[player.Name][1] == player then
			self:DestroyHandle(item)
			print("Player that clicked backspace and dropped is:", player, "and item is:", item)
		end
	end)
end

function item:CreatePrompt(item)
	local Prompt = item.Plane.Attachment:FindFirstChildWhichIsA("ProximityPrompt") or Instance.new("ProximityPrompt")
	Prompt.HoldDuration = 0.5
	Prompt.Parent = item.Plane.Attachment
	self.Prompt = Prompt

	return self.Prompt
end

function item:CreateHandle(item)
	local Handle = item:FindFirstChildWhichIsA("ProximityPrompt") or Instance.new("Part")
	Handle.Size = Vector3.new(1, 1, 1)
	Handle.Parent = item
	Handle.Name = "Handle"
	Handle.Anchored = false
	Handle.CanCollide = false
	Handle.Transparency = 1
	
	Handle.Position = item.Plane.Position
	item.WeldConstraint.Part0 = item.Plane
	item.WeldConstraint.Part1 = Handle
	item.Plane.CanCollide = false
	
	return Handle
end

function item:DestroyHandle(item)
	local Handle = item:FindFirstChild("Handle")
	if Handle then
		item.Plane.CanCollide = true
		Handle:Destroy()
	else
		warn("Handle doesen't exist anymore.")
	end
end

function item:Press(player, itemObject)
	self.object:m_SetItem(player, itemObject)
	self.Triggered:Disconnect()
	self.Prompt:Destroy()
	
	self:CreateHandle(itemObject)
	self:AssignToItemsActive(player, itemObject)
end

function item:AssignToItemsActive(player, item)
	self.itemsActive[player.Name] = {player, item}
end

function item:RemoveFromItemsActive(player, item)
	table.remove(self.itemsActive[player.Name])
end

function item:PublishTopic(topicName, player, ...)
	self._topicEvent:Fire(topicName, self.player, ...)	
	--print("Published topic: " .. topicName)
end

function item:SubscribeTopic(topicName, callBack)
	local connection = self._topicEvent.Event:Connect(function(name, player, ...)
		if name == topicName then
			callBack(player, ...)
		end
	end)
	return connection
end
return item
